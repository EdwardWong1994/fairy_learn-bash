#!/usr/bin/env bash
#
# Delete an account.

#set -o nounset
#set -o errexit
set -o pipefail

# Include libraries
readonly SCRIPT_HOME="$(cd "$(dirname -- "$0")"; pwd -P)"
source "${FAIRY_HOME:-${SCRIPT_HOME}/../..}/_common_lib/output_utils.sh"
source "${FAIRY_HOME:-${SCRIPT_HOME}/../..}/_common_lib/system.sh"
source "${FAIRY_HOME:-${SCRIPT_HOME}/../..}/account/lib/load_script_conf.sh"

# Command parameters
readonly ID="$1"
[[ -n "${ID}" ]]
check_cmd_args "<account_id>"

# Set variables
readonly USERNAME_INIT="${ACCOUNT_USERNAME_INIT-${DEFAULT_USERNAME_INIT}}"

readonly USERNAME="${USERNAME_INIT:+"${USERNAME_INIT}-"}${ID}"

readonly USER_HOME_ROOT=\
"${ACCOUNT_USER_HOME_ROOT:-${DEFAULT_USER_HOME_ROOT:-$(dirname -- "${HOME}")}}"

readonly PEM_HOME="${ACCOUNT_PEM_HOME-${DEFAULT_PEM_HOME}}"

# Delete account and the associated home folder and mailbox file
sudo rm -rf "${USER_HOME_ROOT}/${USERNAME}" &&
sudo rm -f "/var/spool/mail/${USERNAME}" &&
sudo userdel "${USERNAME}"
check_failed "failed to delete account '${USERNAME}'"

# Delete the associated private key
if [[ -n "${PEM_HOME}" ]]; then
  sudo rm -f "${PEM_HOME}/${USERNAME}.pem"
fi

# End of script
info "Account '${USERNAME}' has been deleted successfully"
exit 0
