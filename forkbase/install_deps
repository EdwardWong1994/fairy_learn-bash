#!/usr/bin/env bash
#
# Install ForkBase dependencies on Ubuntu.
#
# https://github.com/streamjoin/forkbase-doc/blob/master/installation/install-deps.md

set -o errexit
set -o pipefail

# Include libraries
readonly SCRIPT_HOME="$(cd "$(dirname -- "${BASH_SOURCE}")"; pwd -P)"
source "${FAIRY_HOME:-${SCRIPT_HOME}/..}/_common_lib/output_utils.sh"
source "${FAIRY_HOME:-${SCRIPT_HOME}/..}/_common_lib/system.sh"

# Check sudo privilege
sudo -v ||
check_err "No sudo privilege for current account '${USER}'"

# Set global variables
readonly BASH_PROFILE="${USTORE_BASH_PROFILE:-"${HOME}/.bash_profile"}"

DEPS_DIR="${USTORE_DEPS_DIR:-"/usr/local/share"}"
mkdir -p "${DEPS_DIR}"
readonly DEPS_DIR="$(cd "${DEPS_DIR}"; pwd -P)"

TEMP_DIR="${USTORE_TEMP_DIR:-"${HOME}/deps_install"}"
mkdir -p "${TEMP_DIR}"
readonly TEMP_DIR="$(cd "${TEMP_DIR}"; pwd -P)"

[[ "${DEPS_DIR}" != "${TEMP_DIR}" ]] ||
check_err "The dependency directory cannot be the same as the temporary directory"

readonly WORK_DIR="$(pwd -P)"
[[ "${WORK_DIR}" != "${TEMP_DIR}" ]] ||
check_err "The temporary directory cannot be the current working directory"

readonly WGET_FLAGS="--quiet --show-progress"

# The main function
main() {
  readonly START_TIME="$(timer)"
  
cat >> "${BASH_PROFILE}" <<-EndOfMsg
export SHARE_HOME="${DEPS_DIR}"
export NCORES="\$(cat /proc/cpuinfo | grep "cpu cores" | uniq | awk '{print \$NF}')"

EndOfMsg
  source "${BASH_PROFILE}"
  
  sudo apt-get -y install build-essential autoconf pkg-config libtool git openssl >/dev/null
  
  info "Installing CMake ..."
  install_cmake
  source "${BASH_PROFILE}"
  
  info "Installing Boost ..."
  install_boost
  
  info "Installing gflags ..."
  install_gflags
  
  info "Installing Protocol Buffers ..."
  install_protobuf
  
  info "Installing Crypto++ ..."
  install_cryptopp
  
  info "Installing ZeroMQ ..."
  install_zmq
  source "${BASH_PROFILE}"
  
  info "Installing CZMQ ..."
  install_czmq
  
  info "Installing RocksDB ..."
  install_rocksdb
  
  info "Installing Google Test ..."
  install_gtest
  
  info "Installing OpenJDK ..."
  install_jdk
  
  info "Installing Maven ..."
  install_maven
  
  info "Installing Python 3 ..."
  install_python3
  
  info "Installing Python 2 ..."
  install_python2
  
  info "Installing CCache ..."
  install_ccache
  
  cd "${WORK_DIR}"
  sudo rm -rf "${TEMP_DIR}"
  
  info "------------------------------------------------------------------------"
  info_bold_green "INSTALLATION SUCCESSFUL"
  info "------------------------------------------------------------------------"
  info "Package versions:"
  info "  - CMake: ${CMAKE_VER}"
  info "  - Boost: ${BOOST_VER}"
  info "  - gflags: ${GFLAGS_VER}"
  info "  - Protocol Buffers: ${PROTOBUF_VER}"
  info "  - Crypto++: ${CRYPTOPP_VER}"
  info "  - ZeroMQ: ${ZMQ_VER}"
  info "  - CZMQ: ${CZMQ_VER}"
  info "  - RocksDB: ${ROCKSDB_VER}"
  info "  - Google Test: ${GTEST_VER}"
  info "  - OpenJDK: ${JDK_VER}"
  info "  - Maven: ${MAVEN_VER}"
  info "  - Python 2: ${PYTHON2_VER}"
  info "  - Python 3: ${PYTHON3_VER}"
  info "  - CCache: ${CCACHE_VER}"
  info "Installed in: ${DEPS_DIR}"
  info "Updated configuration: ${BASH_PROFILE}"
  info "Finished at: $(date +"%T %Z, %-d %B %Y")"
  info "Total time: $(timer "${START_TIME}")"
  info "------------------------------------------------------------------------"
}
# End of the main function

# Installation of dependencies
install_cmake() {
  readonly CMAKE_VER="${USTORE_CMAKE_VER:-"3.13.4"}"
  local -r cmake_pkg="cmake-${CMAKE_VER}.tar.gz"
  local -r cmake_dir="cmake-${CMAKE_VER}"
  
  cd "${TEMP_DIR}"
  [[ -f "${cmake_pkg}" ]] ||
  wget ${WGET_FLAGS} "https://github.com/Kitware/CMake/releases/download/v${CMAKE_VER}/${cmake_pkg}"
  tar xzf "${cmake_pkg}"
  
  cd "${cmake_dir}"
  ./bootstrap --prefix="${SHARE_HOME}/cmake" --parallel="${NCORES}"
  make -j "${NCORES}"
  sudo make install
  
  cd "${TEMP_DIR}" && sudo rm -rf "${cmake_dir}" && rm "${cmake_pkg}"
  
cat >> "${BASH_PROFILE}" <<-'EndOfMsg'
# CMake
export CMAKE_HOME="${SHARE_HOME}/cmake"
export PATH="${CMAKE_HOME}/bin:${PATH}"

EndOfMsg
}

install_boost() {
  readonly BOOST_VER="${USTORE_BOOST_VER:-"1_69_0"}"
  local -r boost_pkg="boost_${BOOST_VER}.tar.bz2"
  local -r boost_dir="boost_${BOOST_VER}"
  
  cd "${TEMP_DIR}"
  [[ -f "${boost_pkg}" ]] ||
  wget ${WGET_FLAGS} "https://dl.bintray.com/boostorg/release/1.69.0/source/${boost_pkg}"
  tar xjf "${boost_pkg}"
  
  cd "${boost_dir}"
  ./bootstrap.sh --prefix="${SHARE_HOME}/boost"
  sudo ./b2 install -j "${NCORES}"
  
  cd "${TEMP_DIR}" && sudo rm -rf "${boost_dir}" && rm "${boost_pkg}"
  
cat >> "${BASH_PROFILE}" <<-'EndOfMsg'
# Boost
export BOOST_ROOT="${SHARE_HOME}/boost"
export CPATH="${BOOST_ROOT}/include:${CPATH}"
export LD_LIBRARY_PATH="${BOOST_ROOT}/lib:${LD_LIBRARY_PATH}"
export LIBRARY_PATH="${BOOST_ROOT}/lib:${LIBRARY_PATH}"

EndOfMsg
}

install_gflags() {
  readonly GFLAGS_VER="${USTORE_GFLAGS_VER:-"2.2.2"}"
  local -r gflags_pkg="v${GFLAGS_VER}.tar.gz"
  local -r gflags_dir="gflags-${GFLAGS_VER}"
  
  cd "${TEMP_DIR}"
  [[ -f "${gflags_pkg}" ]] ||
  wget ${WGET_FLAGS} "https://github.com/gflags/gflags/archive/${gflags_pkg}"
  tar xzf "${gflags_pkg}"
  
  cd "${gflags_dir}"
  mkdir -p build
  rm -rf build/*
  cd build
  cmake -DCMAKE_INSTALL_PREFIX="${SHARE_HOME}/gflags" -DBUILD_SHARED_LIBS=ON -DBUILD_STATIC_LIBS=ON ..
  make -j "${NCORES}"
  sudo make install
  
  cd "${TEMP_DIR}" && sudo rm -rf "${gflags_dir}" && rm "${gflags_pkg}"
  
cat >> "${BASH_PROFILE}" <<-'EndOfMsg'
# gflags
export GFLAGS_ROOT="${SHARE_HOME}/gflags"
export CPATH="${GFLAGS_ROOT}/include:${CPATH}"
export LD_LIBRARY_PATH="${GFLAGS_ROOT}/lib:${LD_LIBRARY_PATH}"
export LIBRARY_PATH="${GFLAGS_ROOT}/lib:${LIBRARY_PATH}"
export CMAKE_INCLUDE_PATH="${GFLAGS_ROOT}/include:${CMAKE_INCLUDE_PATH}"
export CMAKE_LIBRARY_PATH="${GFLAGS_ROOT}/lib:${CMAKE_LIBRARY_PATH}"

EndOfMsg
}

install_protobuf() {
  readonly PROTOBUF_VER="${USTORE_PROTOBUF_VER:-"3.6.1"}"
  local -r protobuf_pkg="v${PROTOBUF_VER}.tar.gz"
  local -r protobuf_dir="protobuf-${PROTOBUF_VER}"
  
  cd "${TEMP_DIR}"
  [[ -f "${protobuf_pkg}" ]] ||
  wget ${WGET_FLAGS} "https://github.com/protocolbuffers/protobuf/archive/${protobuf_pkg}"
  tar xzf "${protobuf_pkg}"
  
  cd "${protobuf_dir}"
  ./autogen.sh
  ./configure --prefix="${SHARE_HOME}/protobuf"
  make -j "${NCORES}"
  sudo make install
  
  cd "${TEMP_DIR}" && sudo rm -rf "${protobuf_dir}" && rm "${protobuf_pkg}"
  
cat >> "${BASH_PROFILE}" <<-'EndOfMsg'
# Protocol Buffers
export PROTOBUF_ROOT="${SHARE_HOME}/protobuf"
export PATH="${PROTOBUF_ROOT}/bin:${PATH}"
export CPATH="${PROTOBUF_ROOT}/include:${CPATH}"
export LD_LIBRARY_PATH="${PROTOBUF_ROOT}/lib:${LD_LIBRARY_PATH}"
export LIBRARY_PATH="${PROTOBUF_ROOT}/lib:${LIBRARY_PATH}"
export CMAKE_INCLUDE_PATH="${PROTOBUF_ROOT}/include:${CMAKE_INCLUDE_PATH}"
export CMAKE_LIBRARY_PATH="${PROTOBUF_ROOT}/lib:${CMAKE_LIBRARY_PATH}"

EndOfMsg
}

install_cryptopp() {
  readonly CRYPTOPP_VER="${USTORE_CRYPTOPP_VER:-"8.0.0"}"
  local -r cryptopp_pkg_ver="CRYPTOPP_${CRYPTOPP_VER//./_}"
  local -r cryptopp_pkg="${cryptopp_pkg_ver}.tar.gz"
  local -r cryptopp_dir="cryptopp-${cryptopp_pkg_ver}"
  
  cd "${TEMP_DIR}"
  [[ -f "${cryptopp_pkg}" ]] ||
  wget ${WGET_FLAGS} "https://github.com/weidai11/cryptopp/archive/${cryptopp_pkg}"
  tar xzf "${cryptopp_pkg}"
  
  cd "${cryptopp_dir}"
  make -j "${NCORES}" libcryptopp.a libcryptopp.so
  sudo make install PREFIX="${SHARE_HOME}/cryptopp"
  
  cd "${TEMP_DIR}" && sudo rm -rf "${cryptopp_dir}" && rm "${cryptopp_pkg}"
  
cat >> "${BASH_PROFILE}" <<-'EndOfMsg'
# Crypto++
export CRYPTOPP_ROOT="${SHARE_HOME}/cryptopp"
export CPATH="${CRYPTOPP_ROOT}/include:${CPATH}"
export LD_LIBRARY_PATH="${CRYPTOPP_ROOT}/lib:${LD_LIBRARY_PATH}"
export LIBRARY_PATH="${CRYPTOPP_ROOT}/lib:${LIBRARY_PATH}"
export CMAKE_INCLUDE_PATH="${CRYPTOPP_ROOT}/include:${CMAKE_INCLUDE_PATH}"
export CMAKE_LIBRARY_PATH="${CRYPTOPP_ROOT}/lib:${CMAKE_LIBRARY_PATH}"

EndOfMsg
}

install_zmq() {
  readonly ZMQ_VER="${USTORE_ZMQ_VER:-"4.3.1"}"
  local -r zmq_pkg="v${ZMQ_VER}.tar.gz"
  local -r zmq_dir="libzmq-${ZMQ_VER}"
  
  cd "${TEMP_DIR}"
  [[ -f "${zmq_pkg}" ]] ||
  wget ${WGET_FLAGS} "https://github.com/zeromq/libzmq/archive/${zmq_pkg}"
  tar xzf "${zmq_pkg}"
  
  cd "${zmq_dir}"
  ./autogen.sh
  ./configure --prefix="${SHARE_HOME}/zmq"
  make -j "${NCORES}"
  sudo make install
  
  cd "${TEMP_DIR}" && sudo rm -rf "${zmq_dir}" && rm "${zmq_pkg}"
  
cat >> "${BASH_PROFILE}" <<-'EndOfMsg'
# ZMQ
export ZMQ_ROOT="${SHARE_HOME}/zmq"
export CPATH="${ZMQ_ROOT}/include:${CPATH}"
export LD_LIBRARY_PATH="${ZMQ_ROOT}/lib:${LD_LIBRARY_PATH}"
export LIBRARY_PATH="${ZMQ_ROOT}/lib:${LIBRARY_PATH}"
export CMAKE_INCLUDE_PATH="${ZMQ_ROOT}/include:${CMAKE_INCLUDE_PATH}"
export CMAKE_LIBRARY_PATH="${ZMQ_ROOT}/lib:${CMAKE_LIBRARY_PATH}"

EndOfMsg
}

install_czmq() {
  readonly CZMQ_VER="${USTORE_CZMQ_VER:-"4.2.0"}"
  local -r czmq_pkg="v${CZMQ_VER}.tar.gz"
  local -r czmq_dir="czmq-${CZMQ_VER}"
  
  cd "${TEMP_DIR}"
  [[ -f "${czmq_pkg}" ]] ||
  wget ${WGET_FLAGS} "https://github.com/zeromq/czmq/archive/${czmq_pkg}"
  tar xzf "${czmq_pkg}"
  
  cd "${czmq_dir}"
  ./autogen.sh
  ./configure --prefix="${SHARE_HOME}/czmq"
  make -j "${NCORES}"
  sudo make install
  
  cd "${TEMP_DIR}" && sudo rm -rf "${czmq_dir}" && rm "${czmq_pkg}"
  
cat >> "${BASH_PROFILE}" <<-'EndOfMsg'
# CZMQ
export CZMQ_ROOT="${SHARE_HOME}/czmq"
export CPATH="${CZMQ_ROOT}/include:${CPATH}"
export LD_LIBRARY_PATH="${CZMQ_ROOT}/lib:${LD_LIBRARY_PATH}"
export LIBRARY_PATH="${CZMQ_ROOT}/lib:${LIBRARY_PATH}"
export CMAKE_INCLUDE_PATH="${CZMQ_ROOT}/include:${CMAKE_INCLUDE_PATH}"
export CMAKE_LIBRARY_PATH="${CZMQ_ROOT}/lib:${CMAKE_LIBRARY_PATH}"

EndOfMsg
}

install_rocksdb() {
  readonly ROCKSDB_VER="${USTORE_ROCKSDB_VER:-"5.17.2"}"
  local -r rocksdb_pkg="v${ROCKSDB_VER}.tar.gz"
  local -r rocksdb_dir="rocksdb-${ROCKSDB_VER}"
  
  sudo apt-get -y install libsnappy-dev zlib1g-dev libbz2-dev liblz4-dev libzstd-dev >/dev/null
  
  cd "${TEMP_DIR}"
  [[ -f "${rocksdb_pkg}" ]] ||
  wget ${WGET_FLAGS} "https://github.com/facebook/rocksdb/archive/${rocksdb_pkg}"
  tar xzf "${rocksdb_pkg}"
  
  cd "${rocksdb_dir}"
  make shared_lib -j "${NCORES}" USE_RTTI=1 DISABLE_WARNING_AS_ERROR=ON
  sudo make install-shared INSTALL_PATH="${SHARE_HOME}/rocksdb"
  
  cd "${TEMP_DIR}" && sudo rm -rf "${rocksdb_dir}" && rm "${rocksdb_pkg}"
  
cat >> "${BASH_PROFILE}" <<-'EndOfMsg'
# RocksDB
export ROCKSDB_ROOT="${SHARE_HOME}/rocksdb"
export CPATH="${ROCKSDB_ROOT}/include:${CPATH}"
export LD_LIBRARY_PATH="${ROCKSDB_ROOT}/lib:${LD_LIBRARY_PATH}"
export LIBRARY_PATH="${ROCKSDB_ROOT}/lib:${LIBRARY_PATH}"
export CMAKE_INCLUDE_PATH="${ROCKSDB_ROOT}/include:${CMAKE_INCLUDE_PATH}"
export CMAKE_LIBRARY_PATH="${ROCKSDB_ROOT}/lib:${CMAKE_LIBRARY_PATH}"

EndOfMsg
}

install_gtest() {
  readonly GTEST_VER="${USTORE_GTEST_VER:-"1.8.1"}"
  local -r gtest_pkg_ver="release-${GTEST_VER}"
  local -r gtest_pkg="${gtest_pkg_ver}.tar.gz"
  local -r gtest_dir="googletest-${gtest_pkg_ver}"
  
  cd "${TEMP_DIR}"
  [[ -f "${gtest_pkg}" ]] ||
  wget ${WGET_FLAGS} "https://github.com/google/googletest/archive/${gtest_pkg}"
  tar xzf "${gtest_pkg}"
  
  cd "${gtest_dir}"
  mkdir -p build
  rm -rf build/*
  cd build
  cmake -DCMAKE_INSTALL_PREFIX="${SHARE_HOME}/gtest" -DBUILD_SHARED_LIBS=ON ..
  make -j "${NCORES}"
  sudo make install
  
  cd "${TEMP_DIR}" && sudo rm -rf "${gtest_dir}" && rm "${gtest_pkg}"
  
cat >> "${BASH_PROFILE}" <<-'EndOfMsg'
# gtest
export GTEST_ROOT="${SHARE_HOME}/gtest"
export CPATH="${GTEST_ROOT}/include:${CPATH}"
export LD_LIBRARY_PATH="${GTEST_ROOT}/lib:${LD_LIBRARY_PATH}"
export LIBRARY_PATH="${GTEST_ROOT}/lib:${LIBRARY_PATH}"
export CMAKE_INCLUDE_PATH="${GTEST_ROOT}/include:${CMAKE_INCLUDE_PATH}"
export CMAKE_LIBRARY_PATH="${GTEST_ROOT}/lib:${CMAKE_LIBRARY_PATH}"

EndOfMsg
}

install_jdk() {
  sudo apt-get -y install default-jdk >/dev/null
  readonly JDK_VER="$(javac -version | awk '{ print $2 }')"
}

install_maven() {
  readonly MAVEN_VER="${USTORE_MAVEN_VER:-"3.6.0"}"
  local -r maven_pkg="apache-maven-${MAVEN_VER}-bin.tar.gz"
  local -r maven_dir="apache-maven-${MAVEN_VER}"
  
  cd "${TEMP_DIR}"
  [[ -f "${maven_pkg}" ]] ||
  wget ${WGET_FLAGS} "https://www-us.apache.org/dist/maven/maven-${MAVEN_VER:0:1}/${MAVEN_VER}/binaries/${maven_pkg}"
  tar xzf "${maven_pkg}"
  
  sudo mkdir -p "${SHARE_HOME}/maven"
  sudo rm -rf "${SHARE_HOME}/maven/${maven_dir}"
  sudo mv "${maven_dir}" "${SHARE_HOME}/maven/"
  
  cd "${TEMP_DIR}" && sudo rm -rf "${maven_dir}" && rm "${maven_pkg}"
  
cat >> "${BASH_PROFILE}" <<-EndOfMsg
# Maven
export MAVEN_HOME="\${SHARE_HOME}/maven/${maven_dir}"
export PATH="\${MAVEN_HOME}/bin:\${PATH}"

EndOfMsg
}

install_python3() {
  readonly PYTHON3_VER="${USTORE_PYTHON3_VER:-"3.7.2"}"
  local -r python3_pkg="Python-${PYTHON3_VER}.tgz"
  local -r python3_dir="Python-${PYTHON3_VER}"
  
  sudo apt-get -y install libffi-dev >/dev/null
  
  cd "${TEMP_DIR}"
  [[ -f "${python3_pkg}" ]] ||
  wget ${WGET_FLAGS} "https://www.python.org/ftp/python/${PYTHON3_VER}/${python3_pkg}"
  tar xzf "${python3_pkg}"
  
  cd "${python3_dir}"
  ./configure --prefix="${SHARE_HOME}/python3"
  make -j "${NCORES}"
  sudo make install
  
  cd "${TEMP_DIR}" && sudo rm -rf "${python3_dir}" && rm "${python3_pkg}"
  
cat >> "${BASH_PROFILE}" <<-'EndOfMsg'
# Python 3
export PYTHON3_ROOT="${SHARE_HOME}/python3"
export PATH="${PYTHON3_ROOT}/bin:${PATH}"

EndOfMsg
}

install_python2() {
  readonly PYTHON2_VER="${USTORE_PYTHON_VER:-"2.7.15"}"
  local -r python2_pkg="Python-${PYTHON2_VER}.tgz"
  local -r python2_dir="Python-${PYTHON2_VER}"
  
  cd "${TEMP_DIR}"
  [[ -f "${python2_pkg}" ]] ||
  wget ${WGET_FLAGS} "https://www.python.org/ftp/python/${PYTHON2_VER}/${python2_pkg}"
  tar xzf "${python2_pkg}"
  
  cd "${python2_dir}"
  ./configure --prefix="${SHARE_HOME}/python"
  make -j "${NCORES}"
  sudo make install
  
  cd "${TEMP_DIR}" && sudo rm -rf "${python2_dir}" && rm "${python2_pkg}"
  
cat >> "${BASH_PROFILE}" <<-'EndOfMsg'
# Python 2
export PYTHON_ROOT="${SHARE_HOME}/python"
export PATH="${PYTHON_ROOT}/bin:${PATH}"

EndOfMsg
}

install_ccache() {
  readonly CCACHE_VER="${USTORE_CCACHE_VER:-"3.6"}"
  local -r ccache_pkg="ccache-${CCACHE_VER}.tar.bz2"
  local -r ccache_dir="ccache-${CCACHE_VER}"
  
  cd "${TEMP_DIR}"
  [[ -f "${ccache_pkg}" ]] ||
  wget ${WGET_FLAGS} "https://www.samba.org/ftp/ccache/${ccache_pkg}"
  tar xjf "${ccache_pkg}"
  
  cd "${ccache_dir}"
  ./configure --prefix="${SHARE_HOME}/ccache"
  make -j "${NCORES}"
  sudo make install
  
  cd "${SHARE_HOME}/ccache/bin"
  sudo rm -f gcc g++ cc c++
  sudo ln -s ccache gcc
  sudo ln -s ccache g++
  sudo ln -s ccache cc
  sudo ln -s ccache c++
  
  cd "${TEMP_DIR}" && sudo rm -rf "${ccache_dir}" && rm "${ccache_pkg}"
  
cat >> "${BASH_PROFILE}" <<-'EndOfMsg'
# ccache
export CCACHE_HOME="${SHARE_HOME}/ccache"
export PATH="${CCACHE_HOME}/bin:${PATH}"
export MANPATH="${CCACHE_HOME}/share/man:${MANPATH}"

EndOfMsg
  
  source "${BASH_PROFILE}"
  ccache -F 0
  ccache -M 1G
}

# Execution
main "$@"
exit "$?"
